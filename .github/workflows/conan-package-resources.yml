name: conan-package-resources-and-notify

on:
  push:
    paths:
      - '.github/workflows/conan-package-resources.yml'
      - 'resources/definitions/**'
      - 'resources/extruders/**'
      - 'resources/images/**'
      - 'resources/intent/**'
      - 'resources/meshes/**'
      - 'resources/quality/**'
      - 'resources/variants/**'
      - 'resources/conanfile.py'
    branches:
      - 'main'
      - 'CURA-*'
      - 'PP-*'
      - 'NP-*'
      - '[0-9].[0-9]*'
      - '[0-9].[0-9][0-9]*'

jobs:
  conan-package:
    uses: ultimaker/cura-workflows/.github/workflows/conan-package.yml@main
    with:
      conan_recipe_root: "./resources/"
      platform_windows: false
      platform_mac: false
      install_system_dependencies: false
    secrets: inherit

  extract-package-version:
    runs-on: ubuntu-latest
    needs: conan-package
    outputs:
      package_version: ${{ steps.get-package-version.outputs.package_version }}

    steps:
      - name: Extract Conan Package Version
        id: get-package-version
        run: |
          # Replace this with your real logic to determine the package version
          PACKAGE_VERSION=$(cat ./resources/conanfile.py | grep version | head -n 1 | cut -d '"' -f 2)
          echo "Detected package version: $PACKAGE_VERSION"

          # Set the package_version as an output for this job
          echo "::set-output name=package_version::$PACKAGE_VERSION"

  # Job 3: Notify the dependent repository
  notify-dependent-package:
    runs-on: ubuntu-latest
    needs: extract-package-version  # This ensures that it runs after extract-package-version

    steps:
      - name: Notify Dependent Repository
        env:
          GITHUB_TOKEN: ${{ secrets.DEPENDENT_REPO_TOKEN }}
        run: |
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/DEPENDENT_ORG/DEPENDENT_REPO/dispatches \
          -d '{"event_type": "dependency-package-change", "client_payload": { "changed_dependency": "dependency-package", "version": "${{ needs.extract-package-version.outputs.package_version }}" }}'